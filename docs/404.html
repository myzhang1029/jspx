<!--
  该页面用于安装 Service Worker
  用户首次访问时，无论请求哪个资源（包括首页），都返回该页面
  该页面尽可能精简，兼容所有浏览器
-->
<html>
<head>
  <meta charset="utf-8">
</head>
<body id="t">
  <svg xmlns="http://www.w3.org/2000/svg" width="100%" height="100%" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid" fill="none">
    <defs><style>.cls-1{font-size:12px;fill:#5f4b00;font-family:SourceCodePro-Regular, Source Code Pro;}</style></defs><text class="cls-1" transform="translate(0 9.96)">Loading</text>
  </svg>
  <script>
  function reload() {
    // 设置最小刷新间隔，防止出错时不停刷新
    var curr = Date.now()
    var last = +sessionStorage._ts || 0
    var count = +sessionStorage._count || 0
    sessionStorage._ts = curr
    sessionStorage._count += 1
    if (curr - last < 1000) {
      return setTimeout(reload, 5000)
    }
    if (count <= 10) {
      location.reload()
    } else {
      t.innerHTML = "Failed to load anything"
    }
  }

  function onfail(err) {
    showErr(err.message)
  }

  function showErr(str) {
    t.innerHTML = str
  }

  function getRootPath() {
    // https://a.com/ -> /
    // https://a.com/index.html -> /
    // https://a.com/path/to/ -> /path/to/
    // https://a.com/path/to -> /path/to/
    // https://a.com/path/to/index.html -> /path/to/
    return location.pathname
      .replace(/\/-+https?:.+/, '')
      .replace(/\w+\.\w+$/, '')
      .replace(/\/*$/, '/')
  }

  function main() {
    if (!self.isSecureContext) {
      showErr("HTTPS required")
      return
    }
    if (!self.ReadableStream) {
      showErr("Use an HTML5 browser please")
      return
    }
    var sw = navigator.serviceWorker
    if (!sw) {
      var ua = navigator.userAgent
      if (/Firefox/.test(ua)) {
        showErr("FireFox private mode unsupported")
      }
      else if (/iPhone|iPad/.test(ua)) {
        showErr("Please use Safari on iOS devices")
      }
      return
    }
    sw
      .register(getRootPath() + "sw.js")
      .then(reload)
      .catch(onfail)
  }
  main()
  </script>
</body>
</html>
